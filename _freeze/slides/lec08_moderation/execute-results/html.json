{
  "hash": "3bb1e428ff87d3ae8dd856610ec44cdc",
  "result": {
    "markdown": "---\ntitle: \"Moderation and Stratification\"\ndate: \"2023-10-30\"\ndescription: \"11\"\n---\n\n\n\n# Setup\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"show\"}\nlibrary(tidyverse)  # general use\nlibrary(ggdist)     # for the \"half-violin\" plot (stat_slab)\nlibrary(ggpubr)     # ggscatter\nlibrary(scales)     # axes labeling\nlibrary(sjPlot)     # side by side barcharts with numbers\nlibrary(gtsummary)  # regression tables\n\npen <- palmerpenguins::penguins\n```\n:::\n\n\n\n## Motivation - Ex. 1 {.smaller}\n\nBelow are the admissions figures for Fall 1973 at UC Berkeley.\n\n|       | Applicants | Admitted |\n|-------|------------|----------|\n| Total | 12,763     | 41%      |\n| Men   | 8,442      | 44%      |\n| Women | 4,321      | 35%      |\n\n: Table of admissions rates at UC Berkeley in 1973\n\nIs there evidence of gender bias in college admissions? Do you think a difference of 35% vs 44% is too large to be by chance?\n\n## Department specific data {.smaller}\n\n|            |            |          |            |          |            |          |\n|------------|------------|----------|------------|----------|------------|----------|\n|            | All        |          | Men        |          | Women      |          |\n| Department | Applicants | Admitted | Applicants | Admitted | Applicants | Admitted |\n| A          | 933        | 64%      | 825        | 62%      | 108        | **82%**  |\n| B          | 585        | 63%      | 560        | 63%      | 25         | **68%**  |\n| C          | 918        | 35%      | 325        | 37%      | 593        | 34%      |\n| D          | 792        | 34%      | 417        | 33%      | 375        | **35%**  |\n| E          | 584        | 25%      | 191        | 28%      | 393        | 24%      |\n| F          | 714        | 6%       | 373        | 6%       | 341        | **7%**   |\n| Total      | 4526       | 39%      | 2691       | 45%      | 1835       | 30%      |\n\n: The table of admissions rates for the 6 largest departments show a different story.\n\nAfter adjusting for features such as size and competitiveness of the department, the pooled data showed a \"small but statistically significant bias in favor of women\"\n\n## Motivation Ex. 2\n\nCan we predict penguin body mass from the flipper length?\n\n::: columns\n::: {.column width=\"50%\"}\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggscatter(pen, x=\"flipper_length_mm\", y = \"body_mass_g\", add = \"reg.line\", \n          color = \"island\", ellipse = TRUE)\n```\n\n::: {.cell-output-display}\n![](lec08_moderation_files/figure-html/unnamed-chunk-3-1.png){width=672}\n:::\n:::\n\n\n:::\n\n::: {.column width=\"50%\"}\nProbably, but the relationship between flipper length and body mass changes depending on what island they are found on.\n:::\n:::\n\n# Moderation {.smaller}\n\nModeration occurs when the relationship between two variables depends on a third variable.\n\n::: columns\n::: {.column width=\"50%\"}\n-   The third variable is referred to as the moderating variable or simply the moderator.\n-   The moderator affects the direction and/or strength of the relationship between the explanatory ($x$) and response ($y$) variable.\n-   So we need a model that can allow for this difference in slope.\n:::\n\n::: {.column width=\"50%\"}\n[![](https://upload.wikimedia.org/wikipedia/commons/thumb/f/fb/Simpsons_paradox_-_animation.gif/220px-Simpsons_paradox_-_animation.gif){fig-align=\"center\" width=\"389\"}](https://en.wikipedia.org/wiki/Simpson%27s_paradox)\n:::\n:::\n\n# Stratification {.smaller}\n\nStratified models fit the regression equations (or any other bivariate analysis) for each subgroup of the population.\n\nThe mathematical model describing the relationship between body mass ($Y$), and flipper length ($X$) for each of the species separately would be written as follows:\n\n$$ Y_{ib} \\sim \\beta_{0b} + \\beta_{1b}*x_{i} + \\epsilon_{ib} \\qquad \\epsilon_{ib} \\sim \\mathcal{N}(0,\\sigma^{2}_{b})$$ \n$$ Y_{id} \\sim \\beta_{0d} + \\beta_{1d}*x_{i} + \\epsilon_{id} \\qquad \\epsilon_{id} \\sim \\mathcal{N}(0,\\sigma^{2}_{c}) $$ \n$$ Y_{it} \\sim \\beta_{0t} + \\beta_{1t}*x_{i} + \\epsilon_{it} \\qquad \\epsilon_{it} \\sim \\mathcal{N}(0,\\sigma^{2}_{t}) $$\n\nwhere $b, d, t$ indicates islands *Biscoe, Dream* and *Torgersen* respectively.\n\n## Stratification\n\n::: {.callout-tip icon=\"true\"}\n### Benefits\n\n-   In each model, the intercept, slope, and variance of the residuals can all be different.\n    -   $Y_{ij} \\sim \\beta_{0j} + \\beta_{1j}*x_{i} + \\epsilon_{ij} \\qquad \\epsilon_{ij} \\sim \\mathcal{N}(0,\\sigma^{2}_{j})$\n-   This is the unique and powerful feature of stratified models.\n:::\n\n::: callout-important\n### Consequences\n\n-   Each model is only fit on the amount of data in that particular subset.\n-   Each model has 3 parameters that need to be estimated: $\\beta_{0}, \\beta_{1}$, and $\\sigma^{2}$\n    -   Total of 9 for the three models.\n-   The more parameters that need to be estimated, the more data we need.\n:::\n\n# Identifying a Moderator\n\nWhen testing a potential moderator, we are asking the question whether there is an association between two constructs, **but separately for different subgroups within the sample.**\n\nWe consider 3 scenarios demonstrating how a third variable can modify the relationship between the original two variables.\n\n## Significant --\\> Non-Significant\n\n-   Significant relationship at bivariate level\n    -   We expect the effect to exist in the entire population\n-   Within at least one level of the third variable the strength of the relationship changes\n    -   P-value is no longer significant within at least one subgroup\n\n## Non-Significant --\\> Significant\n\n-   Non-significant relationship at bivariate level\n    -   We do not expect the effect to exist in the entire population\n-   Within at least one level of the third variable the relationship becomes significant\n    -   P-value is now significant within at least one subgroup\n\n## Change in Direction of Association\n\n-   Significant relationship at bivariate level\n    -   We expect the effect to exist in the entire population\n-   Within at least one level of the third variable the direction of the relationship changes\n    -   Means change order, positive to negative correlation etc.\n\n## What to look for\n\n| ANOVA                                          | Chi-Square                                      | Regression                                                                   |\n|------------------|---------------------------|----------------------------|\n| $p$-value, $R^2$, means, density/boxplot | $p$-value, col percents, side by side barcharts | correlation coefficient ($r$), $p$-value, $\\beta$ coefficients, $r$-squared, scatterplot |\n\nCompare these values within each level of the potential moderator to the values in the overall model. \n\n## Example: ANOVA {.smaller}\n\nDoes sex modify the relationship between flipper length and species? \n\n\n\n\n::: {.cell layout-ncol=\"2\"}\n\n```{.r .cell-code}\nggplot(pen, aes(x=flipper_length_mm, y=species, fill=species)) + \n      stat_slab(alpha=.5, justification = 0) + \n      geom_boxplot(width = .2,  outlier.shape = NA) + \n      geom_jitter(alpha = 0.5, height = 0.05) +\n      stat_summary(fun=\"mean\", geom=\"point\", col=\"red\", size=4, pch=17) + \n      theme_bw() + \n      labs(x=\"Flipper Length (mm)\", y = \"Species\", title = \"Overall\") + \n      theme(legend.position = \"none\")\n```\n\n::: {.cell-output-display}\n![](lec08_moderation_files/figure-html/unnamed-chunk-4-1.png){width=672}\n:::\n\n```{.r .cell-code}\npen %>% select(flipper_length_mm, species, sex) %>% na.omit() %>%\nggplot(aes(x=flipper_length_mm, y=species, fill=species)) + \n      stat_slab(alpha=.5, justification = 0) + \n      geom_boxplot(width = .2,  outlier.shape = NA) + \n      geom_jitter(alpha = 0.5, height = 0.05) +\n      stat_summary(fun=\"mean\", geom=\"point\", col=\"red\", size=4, pch=17) + \n      theme_bw() + \n      labs(x=\"Flipper Length (mm)\", y = \"Species\", title = \"By Sex\") + \n      theme(legend.position = \"none\") + \n  facet_wrap(~sex)\n```\n\n::: {.cell-output-display}\n![](lec08_moderation_files/figure-html/unnamed-chunk-4-2.png){width=672}\n:::\n:::\n\n\n\nThe pattern of distributions of flipper length by species seems the same for both sexes of penguin. Sex is likely _not_ a moderator.\n\n\n## Example: ANOVA (cont.)\n\n::: {.panel-tabset}\n## Overall\n\n:::: {.columns}\n\n::: {.column width=\"80%\"}\n:::{.scrolling}\n\n\n::: {.cell}\n\n```{.r .cell-code}\naov(pen$flipper_length_mm ~ pen$species) |> summary()\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n             Df Sum Sq Mean Sq F value Pr(>F)    \npen$species   2  52473   26237   594.8 <2e-16 ***\nResiduals   339  14953      44                   \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n2 observations deleted due to missingness\n```\n:::\n\n```{.r .cell-code}\naov(pen$flipper_length_mm ~ pen$species) |> performance::r2()\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# R2 for Anova Regression\n       R2: 0.778\n  adj. R2: 0.777\n```\n:::\n:::\n\n\n:::\n:::\n\n::: {.column width=\"20%\"}\nHighly significant p-value, $R^2$ value of 0.77\n:::\n\n::::\n\n\n## By Sex\n\n:::: {.columns}\n\n::: {.column width=\"70%\"}\n:::{.scrolling}\n\n\n::: {.cell}\n\n```{.r .cell-code}\nby(pen, pen$sex, function(x) {\n  p <- aov(x$flipper_length_mm ~ x$species) |> summary()\n  r <- aov(x$flipper_length_mm ~ x$species) |> performance::r2()\n  return(list=c(p, r))\n  })\n```\n\n::: {.cell-output .cell-output-stdout}\n```\npen$sex: female\n[[1]]\n             Df  Sum Sq Mean Sq F value    Pr(>F)    \nx$species     2 21415.6   10708  411.79 < 2.2e-16 ***\nResiduals   162  4212.6      26                      \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n$R2\n       R2 \n0.8356281 \n\n$R2_adjusted\nadjusted R2 \n  0.8335988 \n\n------------------------------------------------------------------------------------------------------------------------------------------------------ \npen$sex: male\n[[1]]\n             Df  Sum Sq Mean Sq F value    Pr(>F)    \nx$species     2 29098.4 14549.2  384.37 < 2.2e-16 ***\nResiduals   165  6245.6    37.9                      \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n$R2\n       R2 \n0.8232924 \n\n$R2_adjusted\nadjusted R2 \n  0.8211504 \n```\n:::\n:::\n\n\n:::\n:::\n\n::: {.column width=\"30%\"}\nP-value still <.0001 in each group, $R^2_{f}= 0.84, R^2_m = 0.82$. Same pattern. \n:::\n\n::::\n\n\n\n## Conclusion\nSex is **not** a modifier, the relationship between species and flipper length is the same within male and female penguins. \n\n:::\n\n\n## Example: Chi-Squared\n\nDoes gender modify the relationship between smoking and general health?\n\n\n\n\n## Example: Regression\n\nDoes the species of an iris moderate the relationship between the length of the sepal and the length of it’s petal.\n\n:::: {.columns}\n\n::: {.column width=\"50%\"}\n\n\n::: {.cell layout-ncol=\"2\"}\n\n```{.r .cell-code}\nggscatter(iris, x=\"Sepal.Length\", y = \"Petal.Length\", \n                     add = \"reg.line\", ellipse = TRUE)\n```\n\n::: {.cell-output-display}\n![](lec08_moderation_files/figure-html/unnamed-chunk-7-1.png){width=672}\n:::\n\n```{.r .cell-code}\nggscatter(iris, x=\"Sepal.Length\", y = \"Petal.Length\", add = \"reg.line\", \n          color = \"Species\", ellipse = TRUE)\n```\n\n::: {.cell-output-display}\n![](lec08_moderation_files/figure-html/unnamed-chunk-7-2.png){width=672}\n:::\n:::\n\n\n:::\n\n::: {.column width=\"50%\"}\nThe slope of the lowess line between virginica and versicolor appear similar in strength, whereas the slope of the line for setosa is closer to zero. Species _may_ be a moderator. \n:::\n\n::::\n\n\n## Example: Regression (cont.)\n\n::: {.panel-tabset}\n## Correlation\n\n:::: {.columns}\n\n::: {.column width=\"60%\"}\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncor(iris$Sepal.Length, iris$Petal.Length)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 0.8717538\n```\n:::\n\n```{.r .cell-code}\nby(iris, iris$Species, function(x) cor(x$Sepal.Length, x$Petal.Length))\n```\n\n::: {.cell-output .cell-output-stdout}\n```\niris$Species: setosa\n[1] 0.2671758\n------------------------------------------------------------------------------------------------------------------------------------------------------ \niris$Species: versicolor\n[1] 0.754049\n------------------------------------------------------------------------------------------------------------------------------------------------------ \niris$Species: virginica\n[1] 0.8642247\n```\n:::\n:::\n\n\n:::\n\n::: {.column width=\"40%\"}\nThe correlation coefficient r for virginica and veriscolor are similar to the overall r value, 0.86 and 0.75 respectively compared to 0.87. \n\nHowever the correlation between sepal and petal length for species setosa is only 0.26.\n:::\n\n::::\n\n## Regression\n\n:::: {.columns}\n\n::: {.column width=\"50%\"}\n\n:::{.scrolling}\n\n\n::: {.cell}\n\n```{.r .cell-code}\nby(iris, iris$Species, function(x) {\n  lm(x$Petal.Length ~ x$Sepal.Length) |> summary() |> broom::tidy()\n  })\n```\n\n::: {.cell-output .cell-output-stdout}\n```\niris$Species: setosa\n# A tibble: 2 × 5\n  term           estimate std.error statistic p.value\n  <chr>             <dbl>     <dbl>     <dbl>   <dbl>\n1 (Intercept)       0.803    0.344       2.34  0.0238\n2 x$Sepal.Length    0.132    0.0685      1.92  0.0607\n------------------------------------------------------------------------------------------------------------------------------------------------------ \niris$Species: versicolor\n# A tibble: 2 × 5\n  term           estimate std.error statistic  p.value\n  <chr>             <dbl>     <dbl>     <dbl>    <dbl>\n1 (Intercept)       0.185    0.514      0.360 7.20e- 1\n2 x$Sepal.Length    0.686    0.0863     7.95  2.59e-10\n------------------------------------------------------------------------------------------------------------------------------------------------------ \niris$Species: virginica\n# A tibble: 2 × 5\n  term           estimate std.error statistic  p.value\n  <chr>             <dbl>     <dbl>     <dbl>    <dbl>\n1 (Intercept)       0.610    0.417       1.46 1.50e- 1\n2 x$Sepal.Length    0.750    0.0630     11.9  6.30e-16\n```\n:::\n:::\n\n\n:::\n:::\n\n::: {.column width=\"50%\"}\n\n* Overall: -7.1 + 1.86x, p<.0001\n* Setosa: 0.08 + 0.13x, p=.06\n* Versicolor: 0.19 + 0.69x, p<.0001\n* Virginica: 0.61 + 0.75x, p<.0001\n\n:::\n\n::::\n\n\n\n\n## Conclusion\n\nIris specis **moderates** the relationship between sepal and petal length.\n:::\n\n\n\n\n",
    "supporting": [
      "lec08_moderation_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}